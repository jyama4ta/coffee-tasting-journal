# テスト仕様書

## 概要

Coffee Tasting Journalのテスト仕様書です。TDD（テスト駆動開発）の原則に従い、実装前にテストを作成しています。

## テスト環境

- **テストフレームワーク**: Vitest 4.x
- **テストライブラリ**: @testing-library/react（UIテスト用）
- **データベース**: SQLite（テストでも本番と同じDBを使用、各テスト前後でクリーンアップ）

## テスト実行方法

```bash
# 全テスト実行
npm test

# 特定ファイルのテスト実行
npm test -- src/__tests__/api/shops.test.ts

# ウォッチモードで実行（ファイル変更時に自動実行）
npm test

# 単発実行（CIモード）
npm test -- --run
```

---

## Shop API テスト

**ファイル:** `src/__tests__/api/shops.test.ts`

### テストケース一覧

| #   | カテゴリ               | テストケース                                     | 期待結果                                 |
| --- | ---------------------- | ------------------------------------------------ | ---------------------------------------- |
| 1   | GET /api/shops         | 空の配列を返す（店舗が存在しない場合）           | 200 + `[]`                               |
| 2   | GET /api/shops         | 全ての店舗を返す                                 | 200 + 店舗配列                           |
| 3   | POST /api/shops        | 新しい店舗を作成する                             | 201 + 作成データ                         |
| 4   | POST /api/shops        | 店舗名のみで作成できる（任意フィールドは省略可） | 201 + 作成データ（任意フィールドはnull） |
| 5   | POST /api/shops        | 店舗名が空の場合は400エラー                      | 400 + エラーメッセージ                   |
| 6   | POST /api/shops        | 店舗名がない場合は400エラー                      | 400 + エラーメッセージ                   |
| 7   | GET /api/shops/[id]    | 指定したIDの店舗を返す                           | 200 + 店舗データ                         |
| 8   | GET /api/shops/[id]    | 存在しないIDの場合は404エラー                    | 404 + エラーメッセージ                   |
| 9   | GET /api/shops/[id]    | 無効なIDの場合は400エラー                        | 400 + エラーメッセージ                   |
| 10  | PUT /api/shops/[id]    | 店舗を更新する                                   | 200 + 更新データ                         |
| 11  | PUT /api/shops/[id]    | 存在しないIDの場合は404エラー                    | 404 + エラーメッセージ                   |
| 12  | PUT /api/shops/[id]    | 名前を空に更新しようとすると400エラー            | 400 + エラーメッセージ                   |
| 13  | DELETE /api/shops/[id] | 店舗を削除する                                   | 204 + DBから削除確認                     |
| 14  | DELETE /api/shops/[id] | 存在しないIDの場合は404エラー                    | 404 + エラーメッセージ                   |

### テスト設計方針

1. **正常系**: 基本的なCRUD操作が正しく動作すること
2. **異常系（バリデーション）**: 不正な入力に対して適切なエラーを返すこと
3. **異常系（存在しないリソース）**: 存在しないIDへのアクセスで404を返すこと
4. **境界値**: 空文字、null、必須フィールドの欠落をテスト

### テストデータ管理

```typescript
// 各テスト前にDBをクリーンアップ
beforeEach(async () => {
  await prisma.shop.deleteMany();
});

// テスト後もクリーンアップ
afterEach(async () => {
  await prisma.shop.deleteMany();
});
```

---

## Dripper API テスト

**ファイル:** `src/__tests__/api/drippers.test.ts`

### テストケース一覧

| #   | カテゴリ                  | テストケース                                           | 期待結果                                 |
| --- | ------------------------- | ------------------------------------------------------ | ---------------------------------------- |
| 1   | GET /api/drippers         | 空の配列を返す（ドリッパーが存在しない場合）           | 200 + `[]`                               |
| 2   | GET /api/drippers         | 全てのドリッパーを返す                                 | 200 + ドリッパー配列                     |
| 3   | POST /api/drippers        | 新しいドリッパーを作成する                             | 201 + 作成データ                         |
| 4   | POST /api/drippers        | ドリッパー名のみで作成できる（任意フィールドは省略可） | 201 + 作成データ（任意フィールドはnull） |
| 5   | POST /api/drippers        | ドリッパー名が空の場合は400エラー                      | 400 + エラーメッセージ                   |
| 6   | POST /api/drippers        | ドリッパー名がない場合は400エラー                      | 400 + エラーメッセージ                   |
| 7   | GET /api/drippers/[id]    | 指定したIDのドリッパーを返す                           | 200 + ドリッパーデータ                   |
| 8   | GET /api/drippers/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                   |
| 9   | GET /api/drippers/[id]    | 無効なIDの場合は400エラー                              | 400 + エラーメッセージ                   |
| 10  | PUT /api/drippers/[id]    | ドリッパーを更新する                                   | 200 + 更新データ                         |
| 11  | PUT /api/drippers/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                   |
| 12  | PUT /api/drippers/[id]    | 名前を空に更新しようとすると400エラー                  | 400 + エラーメッセージ                   |
| 13  | DELETE /api/drippers/[id] | ドリッパーを削除する                                   | 204 + DBから削除確認                     |
| 14  | DELETE /api/drippers/[id] | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                   |

### テスト設計方針

ShopAPIテストと同様の設計方針を適用。

---

## Filter API テスト

**ファイル:** `src/__tests__/api/filters.test.ts`

### テストケース一覧

| #   | カテゴリ                 | テストケース                                           | 期待結果                                    |
| --- | ------------------------ | ------------------------------------------------------ | ------------------------------------------- |
| 1   | GET /api/filters         | 空の配列を返す（フィルターが存在しない場合）           | 200 + `[]`                                  |
| 2   | GET /api/filters         | 全てのフィルターを返す                                 | 200 + フィルター配列                        |
| 3   | POST /api/filters        | 新しいフィルターを作成する                             | 201 + 作成データ                            |
| 4   | POST /api/filters        | フィルター名のみで作成できる（任意フィールドは省略可） | 201 + 作成データ（任意フィールドはnull）    |
| 5   | POST /api/filters        | フィルター種類（type）を指定して作成できる             | 201 + 作成データ（typeがPAPER/METAL/CLOTH） |
| 6   | POST /api/filters        | フィルター名が空の場合は400エラー                      | 400 + エラーメッセージ                      |
| 7   | POST /api/filters        | フィルター名がない場合は400エラー                      | 400 + エラーメッセージ                      |
| 8   | POST /api/filters        | 無効なフィルター種類の場合は400エラー                  | 400 + エラーメッセージ                      |
| 9   | GET /api/filters/[id]    | 指定したIDのフィルターを返す                           | 200 + フィルターデータ                      |
| 10  | GET /api/filters/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                      |
| 11  | GET /api/filters/[id]    | 無効なIDの場合は400エラー                              | 400 + エラーメッセージ                      |
| 12  | PUT /api/filters/[id]    | フィルターを更新する                                   | 200 + 更新データ                            |
| 13  | PUT /api/filters/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                      |
| 14  | PUT /api/filters/[id]    | 名前を空に更新しようとすると400エラー                  | 400 + エラーメッセージ                      |
| 15  | DELETE /api/filters/[id] | フィルターを削除する                                   | 204 + DBから削除確認                        |
| 16  | DELETE /api/filters/[id] | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                      |

### テスト設計方針

ShopAPIテストと同様の設計方針を適用。FilterType（PAPER/METAL/CLOTH）のバリデーションテストを追加。

---

## CoffeeBean API テスト

**ファイル:** `src/__tests__/api/beans.test.ts`

_（未実装）_

### 予定テストケース

| #   | カテゴリ                     | テストケース                                   |
| --- | ---------------------------- | ---------------------------------------------- |
| 1   | GET /api/beans               | 全ての豆を返す                                 |
| 2   | GET /api/beans               | ステータスでフィルタリングできる（在庫中のみ） |
| 3   | POST /api/beans              | 新しい豆を作成する                             |
| 4   | POST /api/beans              | 焙煎度・精製方法を指定して作成できる           |
| 5   | POST /api/beans              | 店舗を紐づけて作成できる                       |
| 6   | GET /api/beans/[id]          | 指定したIDの豆を返す（関連する試飲記録も含む） |
| 7   | PUT /api/beans/[id]          | 豆を更新する                                   |
| 8   | PATCH /api/beans/[id]/status | ステータスを変更できる（在庫中→飲み切り）      |
| 9   | PATCH /api/beans/[id]/status | 飲み切り時に飲み切り日が設定される             |
| 10  | DELETE /api/beans/[id]       | 豆を削除する（関連する試飲記録も削除）         |

---

## TastingEntry API テスト

**ファイル:** `src/__tests__/api/tastings.test.ts`

_（未実装）_

### 予定テストケース

| #   | カテゴリ                  | テストケース                                  |
| --- | ------------------------- | --------------------------------------------- |
| 1   | GET /api/tastings         | 全ての試飲記録を返す                          |
| 2   | GET /api/tastings         | 豆IDでフィルタリングできる                    |
| 3   | POST /api/tastings        | 新しい試飲記録を作成する                      |
| 4   | POST /api/tastings        | 評価値（酸味、苦味など）を設定できる          |
| 5   | POST /api/tastings        | フレーバータグを複数設定できる                |
| 6   | POST /api/tastings        | 存在しない豆IDの場合は400エラー               |
| 7   | POST /api/tastings        | 飲み切りステータスの豆は選択不可（400エラー） |
| 8   | GET /api/tastings/[id]    | 指定したIDの試飲記録を返す                    |
| 9   | PUT /api/tastings/[id]    | 試飲記録を更新する                            |
| 10  | DELETE /api/tastings/[id] | 試飲記録を削除する                            |

---

## テストカバレッジ目標

| 領域               | 目標カバレッジ |
| ------------------ | -------------- |
| API Routes         | 90%以上        |
| ユーティリティ関数 | 80%以上        |
| UIコンポーネント   | 70%以上        |

## テスト命名規約

```
[対象] > [操作/条件] > [期待結果]
```

例:

- `Shop API > GET /api/shops > 空の配列を返す（店舗が存在しない場合）`
- `Shop API > POST /api/shops > 店舗名が空の場合は400エラー`
