# テスト仕様書

## 概要

Coffee Tasting Journalのテスト仕様書です。TDD（テスト駆動開発）の原則に従い、実装前にテストを作成しています。

## テスト環境

- **テストフレームワーク**: Vitest 4.x
- **テストライブラリ**: @testing-library/react（UIテスト用）
- **データベース**: SQLite（テストでも本番と同じDBを使用、各テスト前後でクリーンアップ）

## テスト実行方法

```bash
# 全テスト実行
npm test

# 特定ファイルのテスト実行
npm test -- src/__tests__/api/shops.test.ts

# ウォッチモードで実行（ファイル変更時に自動実行）
npm test

# 単発実行（CIモード）
npm test -- --run
```

---

## Shop API テスト

**ファイル:** `src/__tests__/api/shops.test.ts`

### テストケース一覧

| #   | カテゴリ               | テストケース                                     | 期待結果                                 |
| --- | ---------------------- | ------------------------------------------------ | ---------------------------------------- |
| 1   | GET /api/shops         | 空の配列を返す（店舗が存在しない場合）           | 200 + `[]`                               |
| 2   | GET /api/shops         | 全ての店舗を返す                                 | 200 + 店舗配列                           |
| 3   | POST /api/shops        | 新しい店舗を作成する                             | 201 + 作成データ                         |
| 4   | POST /api/shops        | 店舗名のみで作成できる（任意フィールドは省略可） | 201 + 作成データ（任意フィールドはnull） |
| 5   | POST /api/shops        | 店舗名が空の場合は400エラー                      | 400 + エラーメッセージ                   |
| 6   | POST /api/shops        | 店舗名がない場合は400エラー                      | 400 + エラーメッセージ                   |
| 7   | GET /api/shops/[id]    | 指定したIDの店舗を返す                           | 200 + 店舗データ                         |
| 8   | GET /api/shops/[id]    | 存在しないIDの場合は404エラー                    | 404 + エラーメッセージ                   |
| 9   | GET /api/shops/[id]    | 無効なIDの場合は400エラー                        | 400 + エラーメッセージ                   |
| 10  | PUT /api/shops/[id]    | 店舗を更新する                                   | 200 + 更新データ                         |
| 11  | PUT /api/shops/[id]    | 存在しないIDの場合は404エラー                    | 404 + エラーメッセージ                   |
| 12  | PUT /api/shops/[id]    | 名前を空に更新しようとすると400エラー            | 400 + エラーメッセージ                   |
| 13  | DELETE /api/shops/[id] | 店舗を削除する                                   | 204 + DBから削除確認                     |
| 14  | DELETE /api/shops/[id] | 存在しないIDの場合は404エラー                    | 404 + エラーメッセージ                   |

### テスト設計方針

1. **正常系**: 基本的なCRUD操作が正しく動作すること
2. **異常系（バリデーション）**: 不正な入力に対して適切なエラーを返すこと
3. **異常系（存在しないリソース）**: 存在しないIDへのアクセスで404を返すこと
4. **境界値**: 空文字、null、必須フィールドの欠落をテスト

### テストデータ管理

```typescript
// 各テスト前にDBをクリーンアップ
beforeEach(async () => {
  await prisma.shop.deleteMany();
});

// テスト後もクリーンアップ
afterEach(async () => {
  await prisma.shop.deleteMany();
});
```

---

## Dripper API テスト

**ファイル:** `src/__tests__/api/drippers.test.ts`

### テストケース一覧

| #   | カテゴリ                  | テストケース                                           | 期待結果                                 |
| --- | ------------------------- | ------------------------------------------------------ | ---------------------------------------- |
| 1   | GET /api/drippers         | 空の配列を返す（ドリッパーが存在しない場合）           | 200 + `[]`                               |
| 2   | GET /api/drippers         | 全てのドリッパーを返す                                 | 200 + ドリッパー配列                     |
| 3   | POST /api/drippers        | 新しいドリッパーを作成する                             | 201 + 作成データ                         |
| 4   | POST /api/drippers        | ドリッパー名のみで作成できる（任意フィールドは省略可） | 201 + 作成データ（任意フィールドはnull） |
| 5   | POST /api/drippers        | ドリッパー名が空の場合は400エラー                      | 400 + エラーメッセージ                   |
| 6   | POST /api/drippers        | ドリッパー名がない場合は400エラー                      | 400 + エラーメッセージ                   |
| 7   | GET /api/drippers/[id]    | 指定したIDのドリッパーを返す                           | 200 + ドリッパーデータ                   |
| 8   | GET /api/drippers/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                   |
| 9   | GET /api/drippers/[id]    | 無効なIDの場合は400エラー                              | 400 + エラーメッセージ                   |
| 10  | PUT /api/drippers/[id]    | ドリッパーを更新する                                   | 200 + 更新データ                         |
| 11  | PUT /api/drippers/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                   |
| 12  | PUT /api/drippers/[id]    | 名前を空に更新しようとすると400エラー                  | 400 + エラーメッセージ                   |
| 13  | DELETE /api/drippers/[id] | ドリッパーを削除する                                   | 204 + DBから削除確認                     |
| 14  | DELETE /api/drippers/[id] | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                   |

### テスト設計方針

ShopAPIテストと同様の設計方針を適用。

---

## Filter API テスト

**ファイル:** `src/__tests__/api/filters.test.ts`

### テストケース一覧

| #   | カテゴリ                 | テストケース                                           | 期待結果                                    |
| --- | ------------------------ | ------------------------------------------------------ | ------------------------------------------- |
| 1   | GET /api/filters         | 空の配列を返す（フィルターが存在しない場合）           | 200 + `[]`                                  |
| 2   | GET /api/filters         | 全てのフィルターを返す                                 | 200 + フィルター配列                        |
| 3   | POST /api/filters        | 新しいフィルターを作成する                             | 201 + 作成データ                            |
| 4   | POST /api/filters        | フィルター名のみで作成できる（任意フィールドは省略可） | 201 + 作成データ（任意フィールドはnull）    |
| 5   | POST /api/filters        | フィルター種類（type）を指定して作成できる             | 201 + 作成データ（typeがPAPER/METAL/CLOTH） |
| 6   | POST /api/filters        | フィルター名が空の場合は400エラー                      | 400 + エラーメッセージ                      |
| 7   | POST /api/filters        | フィルター名がない場合は400エラー                      | 400 + エラーメッセージ                      |
| 8   | POST /api/filters        | 無効なフィルター種類の場合は400エラー                  | 400 + エラーメッセージ                      |
| 9   | GET /api/filters/[id]    | 指定したIDのフィルターを返す                           | 200 + フィルターデータ                      |
| 10  | GET /api/filters/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                      |
| 11  | GET /api/filters/[id]    | 無効なIDの場合は400エラー                              | 400 + エラーメッセージ                      |
| 12  | PUT /api/filters/[id]    | フィルターを更新する                                   | 200 + 更新データ                            |
| 13  | PUT /api/filters/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                      |
| 14  | PUT /api/filters/[id]    | 名前を空に更新しようとすると400エラー                  | 400 + エラーメッセージ                      |
| 15  | DELETE /api/filters/[id] | フィルターを削除する                                   | 204 + DBから削除確認                        |
| 16  | DELETE /api/filters/[id] | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ                      |

### テスト設計方針

ShopAPIテストと同様の設計方針を適用。FilterType（PAPER/METAL/CLOTH）のバリデーションテストを追加。

---

## CoffeeBean API テスト

**ファイル:** `src/__tests__/api/beans.test.ts`

### テストケース一覧

| #   | カテゴリ               | テストケース                                   | 期待結果                                  |
| --- | ---------------------- | ---------------------------------------------- | ----------------------------------------- |
| 1   | GET /api/beans         | 空の配列を返す（豆が存在しない場合）           | 200 + `[]`                                |
| 2   | GET /api/beans         | 全ての豆を返す                                 | 200 + 豆配列                              |
| 3   | GET /api/beans         | ステータスでフィルタリングできる（在庫中のみ） | 200 + フィルタリングされた配列            |
| 4   | GET /api/beans         | 関連する店舗情報を含めて返す                   | 200 + shop含む                            |
| 5   | POST /api/beans        | 新しい豆を作成する                             | 201 + 作成データ                          |
| 6   | POST /api/beans        | 豆名のみで作成できる（任意フィールドは省略可） | 201 + 作成データ                          |
| 7   | POST /api/beans        | 店舗を紐づけて作成できる                       | 201 + shopId含む                          |
| 8   | POST /api/beans        | 豆名が空の場合は400エラー                      | 400 + エラーメッセージ                    |
| 9   | POST /api/beans        | 豆名がない場合は400エラー                      | 400 + エラーメッセージ                    |
| 10  | POST /api/beans        | 無効な焙煎度の場合は400エラー                  | 400 + エラーメッセージ                    |
| 11  | POST /api/beans        | 無効な精製方法の場合は400エラー                | 400 + エラーメッセージ                    |
| 12  | POST /api/beans        | 存在しない店舗IDの場合は400エラー              | 400 + エラーメッセージ                    |
| 13  | GET /api/beans/[id]    | 指定したIDの豆を返す（関連する試飲記録も含む） | 200 + tastingEntries含む                  |
| 14  | GET /api/beans/[id]    | 存在しないIDの場合は404エラー                  | 404 + エラーメッセージ                    |
| 15  | GET /api/beans/[id]    | 無効なIDの場合は400エラー                      | 400 + エラーメッセージ                    |
| 16  | PUT /api/beans/[id]    | 豆を更新する                                   | 200 + 更新データ                          |
| 17  | PUT /api/beans/[id]    | 存在しないIDの場合は404エラー                  | 404 + エラーメッセージ                    |
| 18  | PUT /api/beans/[id]    | 名前を空に更新しようとすると400エラー          | 400 + エラーメッセージ                    |
| 19  | PATCH /api/beans/[id]  | ステータスを在庫中から飲み切りに変更できる     | 200 + status=FINISHED + finishedDate設定  |
| 20  | PATCH /api/beans/[id]  | ステータスを飲み切りから在庫中に戻せる         | 200 + status=IN_STOCK + finishedDate=null |
| 21  | PATCH /api/beans/[id]  | 存在しないIDの場合は404エラー                  | 404 + エラーメッセージ                    |
| 22  | PATCH /api/beans/[id]  | 無効なステータスの場合は400エラー              | 400 + エラーメッセージ                    |
| 23  | DELETE /api/beans/[id] | 豆を削除する（関連する試飲記録も削除）         | 204 + DBから削除確認                      |
| 24  | DELETE /api/beans/[id] | 存在しないIDの場合は404エラー                  | 404 + エラーメッセージ                    |

### テスト設計方針

ShopAPIテストと同様の設計方針を適用。以下の追加テストを含む:

- RoastLevel（8段階）、Process（5種類）のバリデーションテスト
- ステータス変更（PATCH）時のfinishedDate自動設定/クリアのテスト
- 関連エンティティ（shop, tastingEntries）のincludeテスト

---

## TastingEntry API テスト

**ファイル:** `src/__tests__/api/tastings.test.ts`

### テストケース一覧

| #   | カテゴリ                  | テストケース                                           | 期待結果                       |
| --- | ------------------------- | ------------------------------------------------------ | ------------------------------ |
| 1   | GET /api/tastings         | 空の配列を返す（試飲記録が存在しない場合）             | 200 + `[]`                     |
| 2   | GET /api/tastings         | 全ての試飲記録を返す                                   | 200 + 試飲記録配列             |
| 3   | GET /api/tastings         | 豆IDでフィルタリングできる                             | 200 + フィルタリングされた配列 |
| 4   | GET /api/tastings         | 関連する豆・ドリッパー・フィルター情報を含めて返す     | 200 + 関連情報含む             |
| 5   | POST /api/tastings        | 新しい試飲記録を作成する                               | 201 + 作成データ               |
| 6   | POST /api/tastings        | 豆IDと抽出日のみで作成できる（任意フィールドは省略可） | 201 + 作成データ               |
| 7   | POST /api/tastings        | 評価値（酸味、苦味など）を設定できる                   | 201 + 評価値含む               |
| 8   | POST /api/tastings        | フレーバータグを複数設定できる                         | 201 + flavorTags含む           |
| 9   | POST /api/tastings        | ドリッパーとフィルターを紐づけて作成できる             | 201 + dripperId, filterId含む  |
| 10  | POST /api/tastings        | 豆IDがない場合は400エラー                              | 400 + エラーメッセージ         |
| 11  | POST /api/tastings        | 抽出日がない場合は400エラー                            | 400 + エラーメッセージ         |
| 12  | POST /api/tastings        | 存在しない豆IDの場合は400エラー                        | 400 + エラーメッセージ         |
| 13  | POST /api/tastings        | 飲み切りステータスの豆は選択不可（400エラー）          | 400 + 「在庫中」メッセージ     |
| 14  | POST /api/tastings        | 無効なボディ値の場合は400エラー                        | 400 + エラーメッセージ         |
| 15  | POST /api/tastings        | 評価値が範囲外の場合は400エラー（1-10）                | 400 + エラーメッセージ         |
| 16  | POST /api/tastings        | 総合評価が範囲外の場合は400エラー（1-5）               | 400 + エラーメッセージ         |
| 17  | GET /api/tastings/[id]    | 指定したIDの試飲記録を返す                             | 200 + 試飲記録データ           |
| 18  | GET /api/tastings/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ         |
| 19  | GET /api/tastings/[id]    | 無効なIDの場合は400エラー                              | 400 + エラーメッセージ         |
| 20  | PUT /api/tastings/[id]    | 試飲記録を更新する                                     | 200 + 更新データ               |
| 21  | PUT /api/tastings/[id]    | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ         |
| 22  | PUT /api/tastings/[id]    | 評価値が範囲外の場合は400エラー                        | 400 + エラーメッセージ         |
| 23  | DELETE /api/tastings/[id] | 試飲記録を削除する                                     | 204 + DBから削除確認           |
| 24  | DELETE /api/tastings/[id] | 存在しないIDの場合は404エラー                          | 404 + エラーメッセージ         |

### テスト設計方針

ShopAPIテストと同様の設計方針を適用。以下の追加テストを含む:

- **豆ステータス制約**: 在庫中（IN_STOCK）の豆のみ試飲記録を作成可能
- **評価値バリデーション**: 酸味・苦味・甘味・後味は1-10、総合評価は1-5の範囲
- **Body値バリデーション**: LIGHT/MEDIUM/HEAVYのいずれか
- **フレーバータグ**: 配列で受け取りJSON文字列として保存
- **関連エンティティ**: coffeeBean, dripper, filterのincludeテスト

---

## テストカバレッジ目標

| 領域               | 目標カバレッジ |
| ------------------ | -------------- |
| API Routes         | 90%以上        |
| ユーティリティ関数 | 80%以上        |
| UIコンポーネント   | 70%以上        |

---

## Button コンポーネントテスト

**ファイル:** `src/__tests__/components/Button.test.tsx`

### テストケース一覧

| #   | カテゴリ         | テストケース                                             | 期待結果                                   |
| --- | ---------------- | -------------------------------------------------------- | ------------------------------------------ |
| 1   | レンダリング     | 子要素を正しくレンダリングする                           | テキストが表示される                       |
| 2   | レンダリング     | button要素としてレンダリングされる（hrefなしの場合）     | button要素が存在                           |
| 3   | レンダリング     | Link要素としてレンダリングされる（hrefありの場合）       | link要素にhref属性あり                     |
| 4   | variant スタイル | primary variant - amber背景・白文字のスタイルを適用する  | bg-amber-600, text-white                   |
| 5   | variant スタイル | secondary variant - gray背景・白文字のスタイルを適用する | bg-gray-600, text-white                    |
| 6   | variant スタイル | danger variant - red背景・白文字のスタイルを適用する     | bg-red-600, text-white                     |
| 7   | variant スタイル | outline variant - 白背景・amber文字・amber枠線           | bg-white, text-amber-600, border-amber-600 |
| 8   | variant スタイル | outline-light variant - 透明背景・白文字・白枠線         | bg-transparent, text-white, border-white   |
| 9   | variant スタイル | デフォルトはprimary variantが適用される                  | bg-amber-600                               |
| 10  | size スタイル    | sm size - 小さいパディングを適用する                     | px-3, py-1.5, text-sm                      |
| 11  | size スタイル    | md size - 中程度のパディングを適用する                   | px-4, py-2, text-base                      |
| 12  | size スタイル    | lg size - 大きいパディングを適用する                     | px-6, py-3, text-lg                        |
| 13  | size スタイル    | デフォルトはmd sizeが適用される                          | px-4, py-2                                 |
| 14  | インタラクション | クリック時にonClickハンドラが呼ばれる                    | ハンドラが1回呼ばれる                      |
| 15  | インタラクション | disabled時はクリックしても反応しない                     | ハンドラ未呼出、disabled属性あり           |
| 16  | 属性             | type属性を指定できる                                     | type="submit"                              |
| 17  | 属性             | デフォルトのtype属性はbutton                             | type="button"                              |
| 18  | 属性             | 追加のclassNameを適用できる                              | カスタムクラスが含まれる                   |

---

## Card コンポーネントテスト

**ファイル:** `src/__tests__/components/Card.test.tsx`

### テストケース一覧

| #   | カテゴリ     | テストケース                            | 期待結果                 |
| --- | ------------ | --------------------------------------- | ------------------------ |
| 1   | レンダリング | リンクが正しいhrefを持つ                | href属性が指定値         |
| 2   | レンダリング | アイコンが表示される                    | アイコン文字が表示       |
| 3   | レンダリング | タイトルが表示される                    | タイトルテキストが表示   |
| 4   | レンダリング | 説明が表示される                        | 説明テキストが表示       |
| 5   | count        | countが指定された場合バッジが表示される | 数値がバッジとして表示   |
| 6   | count        | countが0の場合もバッジが表示される      | 0がバッジとして表示      |
| 7   | count        | countが未指定の場合バッジが表示されない | バッジ要素なし           |
| 8   | color        | デフォルトカラー（bg-amber-50）が適用   | bg-amber-50クラスあり    |
| 9   | color        | カスタムカラーが適用される              | 指定したカラークラスあり |
| 10  | スタイル     | カードに必要な基本スタイルが適用される  | rounded-lg, shadow-md等  |

---

## Navigation コンポーネントテスト

**ファイル:** `src/__tests__/components/Navigation.test.tsx`

### テストケース一覧

| #   | カテゴリ       | テストケース                                 | 期待結果                         |
| --- | -------------- | -------------------------------------------- | -------------------------------- |
| 1   | レンダリング   | ロゴが表示される                             | ロゴテキスト表示                 |
| 2   | レンダリング   | 全てのナビゲーションリンクが表示される       | 6項目すべて表示                  |
| 3   | レンダリング   | ロゴがホームへのリンクを持つ                 | href="/"                         |
| 4   | リンク         | 各リンクが正しいhrefを持つ                   | 各ページへのhref                 |
| 5   | アクティブ状態 | ホームページでホームリンクがアクティブ       | bg-amber-800クラスあり           |
| 6   | アクティブ状態 | 試飲記録ページで試飲記録リンクがアクティブ   | bg-amber-800クラスあり           |
| 7   | アクティブ状態 | サブページでも親ページがアクティブになる     | /tastings/newで試飲記録有効      |
| 8   | アクティブ状態 | 非アクティブなリンクはアクティブスタイルなし | text-amber-100、bg-amber-800なし |

---

## テスト命名規約

```
[対象] > [操作/条件] > [期待結果]
```

例:

- `Shop API > GET /api/shops > 空の配列を返す（店舗が存在しない場合）`
- `Shop API > POST /api/shops > 店舗名が空の場合は400エラー`
- `Button コンポーネント > variant スタイル > outline-light variant - 透明背景・白文字・白枠線のスタイルを適用する`
