# 開発ガイドライン

このファイルはCoffee Tasting Journalの開発ルールを定義します。

## 作業前の確認 - 最重要

### 大規模な変更には事前説明と許可が必要

**以下の作業を行う前に、必ず作業内容を説明してユーザーの許可を得ること:**

- データモデル（Prismaスキーマ）の変更
- 新しい画面・ページの作成
- APIエンドポイントの追加・変更
- 既存機能の大幅な変更
- 複数ファイルにまたがる変更

**事前説明に含めるべき内容:**

```
1. 変更の概要（何を、なぜ変更するか）
2. 影響範囲（変更されるファイル一覧）
3. 作業手順（TDDフローに沿った実施順序）
4. 想定されるリスクや注意点
```

**禁止事項:**

```
❌ 説明なしにいきなりファイルを編集する
❌ 許可を得ずに大規模な変更を開始する
```

**許可された後の実行:**

```
✅ ユーザーから「進めて」「OK」などの許可を得てから作業開始
✅ 作業中も適宜進捗を報告
```

## TDD（テスト駆動開発）- 最重要

### 適用範囲

**TDDは全てのコード修正に適用する:**

- 新機能の実装
- バグ修正
- リファクタリング
- パフォーマンス改善
- 依存関係の更新

### 必ず守ること

**全てのコード修正時は必ず以下の順序で行う:**

```
1. Red:      テストを先に書く → テストが失敗することを確認
2. Green:    最小限の実装でテストを通す
3. Refactor: コードを改善（テストは通ったまま）
```

### 修正タイプ別フロー

#### 新機能の実装

```
1. 機能要件からテストケースを設計
2. テストを書く → 失敗確認（Red）
3. 実装 → テスト成功（Green）
4. リファクタリング
```

#### バグ修正

```
1. バグを再現するテストを書く → 失敗確認（Red）
2. バグを修正 → テスト成功（Green）
3. 関連するエッジケーステストを追加
4. リファクタリング
```

#### リファクタリング

```
1. 既存テストが全て通ることを確認
2. 必要に応じてテストを追加（カバレッジ確保）
3. リファクタリング実施
4. 全テストが通ることを確認
```

#### 依存関係の更新

```
1. 全テストが通ることを確認
2. 依存関係を更新
3. 全テストを再実行
4. 失敗したテストがあれば原因を特定し修正
```

### t_wadaの原則を厳守

- **テストコードは最初に書く**（Red → Green → Refactor）
- **テストしやすい設計を優先**
- **テストの可読性を重視**（テストコードも製品コード）
- **適切な粒度でのテスト分割**

### 実装フロー例（UIコンポーネント）

```
1. テストファイルを作成: src/__tests__/components/MyComponent.test.tsx
2. テストケースを定義（レンダリング、インタラクション、境界値等）
3. テスト実行 → 失敗を確認（Red）
4. コンポーネントを実装: src/components/MyComponent.tsx
5. テスト実行 → 成功を確認（Green）
6. リファクタリング（テストは通ったまま）
7. テスト仕様書を更新: docs/test-specification.md
```

### 実装フロー例（API）

```
1. テストファイルを作成: src/__tests__/api/resource.test.ts
2. テストケースを定義（CRUD、バリデーション、エラーハンドリング等）
3. テスト実行 → 失敗を確認（Red）
4. APIを実装: src/app/api/resource/route.ts
5. テスト実行 → 成功を確認（Green）
6. リファクタリング
7. API仕様書・テスト仕様書を更新
```

## コミュニケーション

### 言語

- **すべての回答・コメント・ドキュメントは日本語で記述すること**

### コミットメッセージ

日本語で記載し、それまでの作業内容を説明すること:

```
1行目: 変更の概要（50文字程度）
空行
3行目以降: 変更の詳細（何を、なぜ、どのように変更したか）
```

例:

```
豆マスターのCRUD APIを実装

- GET /api/beans: 豆一覧取得（ステータスでのフィルタリング対応）
- POST /api/beans: 新規豆登録（バリデーション付き）
- GET /api/beans/[id]: 豆詳細取得（関連する試飲記録も含む）
- PUT /api/beans/[id]: 豆情報更新
- DELETE /api/beans/[id]: 豆削除（関連する試飲記録も削除）

Prisma Clientを使用してタイプセーフなDB操作を実現。
```

## ターミナル操作

- **作業ディレクトリ**: プロジェクトルートから移動しないこと（`cd` 禁止）
- **パス指定**: すべて相対パスで指定すること
- **操作範囲**: プロジェクトルート配下のみ操作可能
- **エラー発生時の対応**:
  1. コマンドが失敗した場合、まず原因を分析する
  2. 原因と、それを踏まえた次のコマンドについて説明する
  3. ユーザーの許可を得てから次のコマンドを実行する

## ドキュメント管理

### 配置場所

`/docs` フォルダ配下で一元管理

### 構成

| ファイル                | 内容                                                      |
| ----------------------- | --------------------------------------------------------- |
| `PROGRESS.md`           | 開発進捗メモ（完了した作業、TODO、技術的課題）            |
| `api-specification.md`  | API仕様書（エンドポイント、データモデル、バリデーション） |
| `test-specification.md` | テスト仕様書（テストケース一覧、テスト設計方針）          |
| `data-model.md`         | ER図とエンティティ詳細                                    |
| `state-diagram.md`      | 状態遷移図とバリデーションルール                          |
| `architecture.md`       | システムアーキテクチャ設計                                |

### 同期更新ルール

- **ソースコード修正時は関連ドキュメントも必ず更新すること**
- 新規API実装時は`api-specification.md`にエンドポイント仕様を追加
- テスト作成時は`test-specification.md`にテストケース一覧を追加
- 機能完了時は`PROGRESS.md`の完了作業に記録

## 設計プロセス

- **データモデル設計**: 実装前に必ず状態遷移図を作成し、データモデルを明確化すること
- コーディングは状態遷移図のレビュー完了後に開始
- データの整合性とライフサイクルを事前に検証

## 実装優先順位

1. **CRUD機能**: 試飲記録の作成・表示・編集・削除
2. **フィルタリング・検索**: 産地、焙煎度、評価などでの絞り込み
3. **シンプルなUI**: 記録の入力と一覧表示に最適化
4. **データ永続化**: Dockerボリュームまたは外部ストレージでのデータ保持
5. **入力支援**: 産地・銘柄の入力時に過去の入力履歴からオートコンプリート表示

## テスト設計の注意点

### JSON文字列フィールドのエッジケース

DBにJSON文字列として保存するフィールド（例: `flavorTags`）は、以下のエッジケースを必ずテストすること:

```typescript
// テストすべきケース
- null
- 未指定（undefined）
- 空配列 []
- 空文字列 ""
- 不正なJSON文字列
```

### 安全なJSONパース関数を使用

ページコンポーネントでJSONフィールドを表示する際は、直接`JSON.parse()`を呼ばず、安全なパース関数を使用すること:

```typescript
// ❌ 危険: nullや不正なJSONでクラッシュする
{JSON.parse(data.flavorTags).map(...)}

// ✅ 安全: エラー時は空配列を返す
function parseFlavorTags(flavorTags: string | null): string[] {
  if (!flavorTags || flavorTags === "[]") return [];
  try {
    const parsed = JSON.parse(flavorTags);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}
```

### APIテストとページテストの両方が必要

- **APIテスト**: データの保存・取得が正しく動作することを確認
- **ページコンポーネント/E2Eテスト**: 表示時にエッジケースでクラッシュしないことを確認

## Next.js App Router の注意点

### 動的データ取得ページは静的生成を無効化すること

Next.js App Router では、デフォルトでページが静的生成（Static Generation）される場合があります。
**DBからデータを取得するページでは、必ず `dynamic = 'force-dynamic'` を設定すること。**

```typescript
// ❌ 静的生成されるため、DBの変更が反映されない
import { prisma } from "@/lib/prisma";

export default async function ListPage() {
  const items = await prisma.item.findMany();
  // ...
}

// ✅ 動的レンダリングを強制し、常に最新データを取得
import { prisma } from "@/lib/prisma";

export const dynamic = "force-dynamic";

export default async function ListPage() {
  const items = await prisma.item.findMany();
  // ...
}
```

### 対象ページ

以下のページには必ず `export const dynamic = "force-dynamic";` を追加すること：

- 一覧ページ（`page.tsx`）: DBから一覧を取得
- 詳細ページ（`[id]/page.tsx`）: DBから個別データを取得
- 編集ページ（`[id]/edit/page.tsx`）: Client Component の場合は不要（useEffect で取得するため）
- 新規作成ページ（`new/page.tsx`）: 選択肢をDBから取得する場合は必要

### 静的生成が適切なページ

以下のページは静的生成のままで問題ない：

- 管理画面トップ（`/admin/page.tsx`）: DBアクセスなし、メニュー表示のみ
- 純粋なClient Component: useEffectでデータ取得するため
